<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PiBells Schedule</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header>
    <img src="/static/pibells-logo.png" alt="PiBells logo" class="logo" />
    <div id="current-time"></div>
    <nav>
      <a href="/admin"><i class="fas fa-cog"></i> Settings</a> |
      <a href="/buttons"><i class="fas fa-bell"></i> Buttons</a> |
      <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
  </header>
  <div id="quick-buttons"></div>
  <h1>Bell Schedule</h1>
  <div>
    <label>Active schedule:
      <select id="schedule-select"></select>
    </label>
    <button id="set-schedule"><i class="fas fa-check"></i> Set Schedule</button>
    <input type="text" id="new-schedule" placeholder="New schedule">
    <button id="add-schedule"><i class="fas fa-plus"></i> Add</button>
  </div>
  <div id="schedule-grid" class="schedule-grid"></div>
  <script>
let audioFiles = [];
let audioMap = {};

function formatTime12h(str) {
  const parts = str.split(':');
  let hour = parseInt(parts[0], 10);
  const minute = parts[1] || '00';
  const ampm = hour >= 12 ? 'PM' : 'AM';
  hour = hour % 12;
  if (hour === 0) hour = 12;
  return `${hour.toString().padStart(2, '0')}:${minute} ${ampm}`;
}

function to24h(str) {
  const m = str.trim().match(/^(\d{1,2}):(\d{2})\s*([AaPp][Mm])$/);
  if (!m) return null;
  let h = parseInt(m[1], 10);
  const min = m[2];
  const ampm = m[3].toUpperCase();
  if (h < 1 || h > 12) return null;
  if (ampm === 'PM' && h !== 12) h += 12;
  if (ampm === 'AM' && h === 12) h = 0;
  return `${h.toString().padStart(2, '0')}:${min}`;
}
async function loadButtons() {
  const res = await fetch('/api/buttons');
  const data = await res.json();
  const container = document.getElementById('quick-buttons');
  container.innerHTML = '';
  data.forEach(btn => {
    const b = document.createElement('button');
    if (btn.icon) {
      b.innerHTML = `<i class="fas ${btn.icon}"></i> ${btn.name}`;
    } else {
      b.textContent = btn.name;
    }
    b.style.background = btn.color;
    b.onclick = async () => {
      await fetch('/api/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sound_file: btn.sound_file })
      });
    };
    container.appendChild(b);
  });
}
async function loadSchedule() {
  const res = await fetch('/api/schedule');
  const data = await res.json();
  const grid = document.getElementById('schedule-grid');
  grid.innerHTML = '';
  const days = ['Monday','Tuesday','Wednesday','Thursday','Friday'];
  for (let d=0; d<5; d++) {
    const div = document.createElement('div');
    div.className = 'schedule-day';
    const h = document.createElement('h3');
    h.textContent = days[d];
    div.appendChild(h);
    const ul = document.createElement('ul');
    data.map((e,i)=>({...e, index:i}))
        .filter(e=>e.day===d)
        .sort((a,b)=>a.time.localeCompare(b.time))
        .forEach(ev => {
          const li = document.createElement('li');
          const display = audioMap[ev.sound_file] || ev.sound_file;
          const timeDisp = formatTime12h(ev.time);
          li.textContent = `${timeDisp} - ${display}`;
          const btn = document.createElement('button');
          btn.innerHTML = '<i class="fas fa-trash"></i> Remove';
          btn.onclick = async () => {
            await fetch('/api/schedule/' + ev.index, { method: 'DELETE' });
            loadSchedule();
          };
          li.appendChild(btn);
          ul.appendChild(li);
        });
    div.appendChild(ul);
    const form = document.createElement('form');
    form.className = 'add-event-form';
    const t = document.createElement('input');
    t.type = 'text';
    t.placeholder = 'HH:MM AM/PM';
    t.required = true;
    const sel = document.createElement('select');
    audioFiles.forEach(file => {
      const opt = document.createElement('option');
      opt.value = file.file;
      opt.textContent = file.name;
      sel.appendChild(opt);
    });
    const addBtn = document.createElement('button');
    addBtn.type = 'submit';
    addBtn.innerHTML = '<i class="fas fa-plus"></i> Add';
    form.appendChild(t);
    form.appendChild(sel);
    form.appendChild(addBtn);
    form.onsubmit = async (e) => {
      e.preventDefault();
      const val = to24h(t.value);
      if (!val) {
        alert('Invalid time format. Use HH:MM AM/PM');
        return;
      }
      await fetch('/api/schedule', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ day: d, time: val, sound_file: sel.value })
      });
      loadSchedule();
    };
    div.appendChild(form);
    grid.appendChild(div);
  }
}
async function loadScheduleList() {
  const res = await fetch('/api/schedules');
  const data = await res.json();
  const select = document.getElementById('schedule-select');
  select.innerHTML = '';
  data.schedules.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    if (name === data.active) opt.selected = true;
    select.appendChild(opt);
  });
}
async function loadAudio() {
  const res = await fetch('/api/audio');
  audioFiles = await res.json();
  audioMap = {};
  audioFiles.forEach(f => { audioMap[f.file] = f.name; });
}
document.getElementById('set-schedule').onclick = async () => {
  const name = document.getElementById('schedule-select').value;
  await fetch('/api/schedules/activate/' + encodeURIComponent(name), { method: 'POST' });
  loadSchedule();
};
document.getElementById('add-schedule').onclick = async () => {
  const name = document.getElementById('new-schedule').value.trim();
  if (!name) return;
  await fetch('/api/schedules', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name })
  });
  document.getElementById('new-schedule').value = '';
  loadScheduleList();
  loadSchedule();
};
loadScheduleList();
loadAudio().then(loadSchedule);
loadButtons();
function updateTime() {
  const now = new Date();
  const pad = n => n.toString().padStart(2, '0');
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  let hours = now.getHours();
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12;
  if (hours === 0) hours = 12;
  const str = `${days[now.getDay()]} ${pad(hours)}:${pad(now.getMinutes())}:${pad(now.getSeconds())} ${ampm}`;
  document.getElementById('current-time').textContent = str;
}
updateTime();
  setInterval(updateTime, 1000);
  </script>
  <div class="theme-switch">
    <select id="theme-select">
      <option value="auto">Auto</option>
      <option value="light">Light</option>
      <option value="dark">Dark</option>
    </select>
  </div>
  <footer>
    <div class="footer-left">
      <img src="/static/smallroundlogo.png" alt="PixelPacific logo" class="footer-logo" />
      <span>&copy; 2025 <a href="https://www.pixelpacific.com" target="_blank">PixelPacific LLC.</a></span>
    </div>
    <div id="hostname" class="footer-right"></div>
  </footer>
  <script>
  async function loadHostname() {
    try {
      const res = await fetch('/api/network');
      const data = await res.json();
      document.getElementById('hostname').textContent = data.hostname;
    } catch (e) {
      console.error(e);
    }
  }
  loadHostname();
  </script>
  <script src="/static/theme.js"></script>
</body>
</html>
