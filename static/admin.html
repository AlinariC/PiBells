<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Device Configuration</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body class="settings-page">
  <header>
    <img src="/static/pibells-logo.png" alt="PiBells logo" class="logo" />
    <div id="current-time"></div>
    <button id="menu-toggle" class="hamburger" aria-label="Menu">
      <span></span><span></span><span></span>
    </button>
    <nav>
      <a href="/"><span class="icon">â†</span> Back to Schedule</a>
      <a href="/logout"><span class="icon">ğŸšª</span> Logout</a>
    </nav>
  </header>
  <h1>Barix Devices</h1>
  <form id="add-form">
    <label>Device IP: <input type="text" id="ip" placeholder="192.168.1.10" required></label>
    <button type="submit" class="btn"><span class="icon">â•</span> Add</button>
  </form>
  <label>Network: <input type="text" id="scan-net" placeholder="192.168.1"></label>
  <button id="scan-btn" class="btn"><span class="icon">ğŸ”</span> Scan Network</button>
  <progress id="scan-progress" value="0" max="254" style="display:none;"></progress>
  <table id="devices">
    <thead><tr><th>IP</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>

  <h2>Network</h2>
  <div id="network-info" class="network-info">
    <span class="icon">ğŸ–§</span>
    <span id="hostname-display"></span> - <span id="ip-display"></span>
  </div>

  <h2>Audio Files</h2>
  <form id="upload-form">
    <input type="file" id="audio-file" accept="audio/*" required>
    <input type="text" id="audio-name" placeholder="Name" required>
    <button type="submit" class="btn"><span class="icon">â¬†ï¸</span> Upload</button>
  </form>
  <div id="audio-list" class="audio-grid"></div>

  <h2>Test</h2>
  <div class="test-section">
    <label>Sound file: <select id="test-sound"></select></label>
    <button id="test-play" class="btn"><span class="icon">â–¶ï¸</span> Play</button>
  </div>

  <h2>Software</h2>
  <p id="version-display"></p>
  <button id="check-version" class="btn"><span class="icon">ğŸ”„</span> Check for Updates</button>
  <button id="update-btn" class="btn"><span class="icon">â¬‡ï¸</span> Update</button>
  <button id="reboot-btn" class="btn"><span class="icon">â»</span> Reboot</button>
  <div id="update-message" class="update-message" style="display:none;"></div>
  <script>
  async function loadNetwork() {
    const res = await fetch('/api/network');
    const data = await res.json();
    const ip = document.getElementById('ip-display');
    const host = document.getElementById('hostname-display');
    if (ip) ip.textContent = data.ip;
    if (host) host.textContent = data.hostname;
  }

  async function loadDevices() {
    const res = await fetch('/api/devices');
    const data = await res.json();
    const tbody = document.querySelector('#devices tbody');
    tbody.innerHTML = '';
    data.forEach((ip, i) => {
      const tr = document.createElement('tr');
      const ipTd = document.createElement('td');
      ipTd.textContent = ip;
      const statusTd = document.createElement('td');
      statusTd.innerHTML = '<span class="status-icon icon" data-ip="' + ip + '">â—</span>';
      const btn = document.createElement('button');
      btn.className = 'btn btn-danger';
      btn.innerHTML = '<span class="icon">ğŸ—‘</span> Delete';
      btn.onclick = async () => {
        await fetch('/api/devices/' + i, { method: 'DELETE' });
        loadDevices();
      };
      const actionTd = document.createElement('td');
      actionTd.appendChild(btn);
      tr.appendChild(ipTd);
      tr.appendChild(statusTd);
      tr.appendChild(actionTd);
      tbody.appendChild(tr);
    });
    updateStatuses();
  }

  async function updateStatuses() {
    const res = await fetch('/api/devices/status');
    const data = await res.json();
    document.querySelectorAll('.status-icon').forEach(icon => {
      const ip = icon.dataset.ip;
      if (data[ip]) {
        icon.style.color = 'green';
      } else {
        icon.style.color = 'red';
      }
    });
  }

  setInterval(updateStatuses, 5000);

  document.getElementById('add-form').onsubmit = async (e) => {
    e.preventDefault();
    const ip = document.getElementById('ip').value;
    await fetch('/api/devices', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ip })
    });
    e.target.reset();
    loadDevices();
  };

  loadDevices();
  loadNetwork();

  document.getElementById('scan-btn').onclick = () => {
    const net = document.getElementById('scan-net').value;
    const url = net ? '/api/devices/scan_stream?network=' + encodeURIComponent(net) : '/api/devices/scan_stream';
    const progress = document.getElementById('scan-progress');
    progress.value = 0;
    progress.style.display = 'inline';
    const es = new EventSource(url);
    es.onmessage = async (e) => {
      const data = JSON.parse(e.data);
      if ('progress' in data) progress.value = data.progress;
      if (data.device) {
        await fetch('/api/devices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ip: data.device })
        });
      }
      if (data.complete || data.error) {
        es.close();
        progress.style.display = 'none';
        if (data.error) alert(data.error);
        loadDevices();
      }
    };
  };

  async function loadAudio() {
    const res = await fetch('/api/audio');
    const data = await res.json();
    const list = document.getElementById('audio-list');
    list.innerHTML = '';
    const testSelect = document.getElementById('test-sound');
    if (testSelect) testSelect.innerHTML = '';
    data.forEach(file => {
      const div = document.createElement('div');
      div.className = 'audio-item';
      const span = document.createElement('span');
      span.textContent = file.name;
      div.appendChild(span);
      const edit = document.createElement('button');
      edit.className = 'btn';
      edit.innerHTML = '<span class="icon">âœï¸</span>';
      edit.onclick = async () => {
        const name = prompt('New name:', file.name);
        if (!name) return;
        await fetch('/api/audio/' + encodeURIComponent(file.file), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        loadAudio();
      };
      div.appendChild(edit);
      const del = document.createElement('button');
      del.className = 'btn btn-danger';
      del.innerHTML = '<span class="icon">ğŸ—‘</span>';
      del.onclick = async () => {
        if (!confirm('Delete this file?')) return;
        await fetch('/api/audio/' + encodeURIComponent(file.file), { method: 'DELETE' });
        loadAudio();
      };
      div.appendChild(del);
      list.appendChild(div);
      if (testSelect) {
        const opt = document.createElement('option');
        opt.value = file.file;
        opt.textContent = file.name;
        testSelect.appendChild(opt);
      }
    });
  }

  document.getElementById('upload-form').onsubmit = async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById('audio-file');
    const nameInput = document.getElementById('audio-name');
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('name', nameInput.value);
    await fetch('/api/audio', { method: 'POST', body: formData });
    fileInput.value = '';
    nameInput.value = '';
    loadAudio();
  };

  loadAudio();

  document.getElementById('test-play').onclick = async () => {
    const sound = document.getElementById('test-sound').value;
    if (!sound) return;
    await fetch('/api/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sound_file: sound })
    });
  };

  async function loadVersion() {
    try {
      const res = await fetch('/api/version');
      const data = await res.json();
      document.getElementById('version-display').textContent =
        `Version: ${data.current} (latest ${data.latest})`;
    } catch (e) {
      console.error(e);
    }
  }

  document.getElementById('check-version').onclick = loadVersion;

  document.getElementById('update-btn').onclick = async () => {
    if (!confirm('Update PiBells now?')) return;
    const btn = document.getElementById('update-btn');
    const msg = document.getElementById('update-message');
    btn.disabled = true;
    msg.style.display = 'none';
    try {
      const res = await fetch('/api/update', { method: 'POST' });
      if (!res.ok) throw new Error('Update failed');
      msg.innerHTML = '<span class="icon">âœ…</span> Update complete, please reboot system.';
      msg.style.display = 'inline-flex';
    } catch (e) {
      alert(e);
    } finally {
      btn.disabled = false;
      loadVersion();
    }
  };

  document.getElementById('reboot-btn').onclick = async () => {
    if (!confirm('Reboot the device now?')) return;
    await fetch('/api/reboot', { method: 'POST' });
  };

  loadVersion();
  function updateTime() {
    const now = new Date();
    const pad = n => n.toString().padStart(2, '0');
    const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    let hours = now.getHours();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    if (hours === 0) hours = 12;
    const str = `${days[now.getDay()]} ${pad(hours)}:${pad(now.getMinutes())}:${pad(now.getSeconds())} ${ampm}`;
    document.getElementById('current-time').textContent = str;
  }
  updateTime();
  setInterval(updateTime, 1000);
  </script>
  <footer>
    <div class="footer-left">
      <img src="/static/smallroundlogo.png" alt="PixelPacific logo" class="footer-logo" />
      <span>&copy; 2025 <a href="https://www.pixelpacific.com" target="_blank">PixelPacific LLC.</a></span>
    </div>
    <div class="theme-switch">
      <button class="theme-btn" data-theme="light" title="Light">ğŸŒ</button>
      <button class="theme-btn" data-theme="auto" title="Auto">ğŸŒ“</button>
      <button class="theme-btn" data-theme="dark" title="Dark">ğŸŒœ</button>
    </div>
    <div id="hostname" class="footer-right"></div>
  </footer>
  <script>
  async function loadHostname() {
    try {
      const res = await fetch('/api/network');
      const data = await res.json();
      document.getElementById('hostname').textContent = data.hostname;
    } catch (e) {
      console.error(e);
    }
  }
  loadHostname();
  </script>
  <script src="/static/theme.js"></script>
</body>
</html>
