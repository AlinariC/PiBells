<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Device Configuration</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header>
    <img src="/static/pibells-logo.png" alt="PiBells logo" class="logo" />
    <a href="/"><i class="fas fa-arrow-left"></i> Back to Schedule</a>
  </header>
  <h1>Barix Devices</h1>
  <form id="add-form">
    <label>Device IP: <input type="text" id="ip" placeholder="192.168.1.10" required></label>
    <button type="submit"><i class="fas fa-plus"></i> Add</button>
  </form>
  <label>Network: <input type="text" id="scan-net" placeholder="192.168.1"></label>
  <button id="scan-btn"><i class="fas fa-search"></i> Scan Network</button>
  <progress id="scan-progress" value="0" max="254" style="display:none;"></progress>
  <table id="devices">
    <thead><tr><th>IP</th><th>Status</th><th>Actions</th></tr></thead>
    <tbody></tbody>
  </table>

  <h2>Network</h2>
  <p id="ip-display"></p>

  <h2>Audio Files</h2>
  <form id="upload-form">
    <input type="file" id="audio-file" accept="audio/*" required>
    <input type="text" id="audio-name" placeholder="Name" required>
    <button type="submit"><i class="fas fa-upload"></i> Upload</button>
  </form>
  <div id="audio-list" class="audio-grid"></div>

  <h2>Test</h2>
  <div class="test-section">
    <label>Sound file: <select id="test-sound"></select></label>
    <button id="test-play"><i class="fas fa-play"></i> Play</button>
  </div>
  <script>
  async function loadNetwork() {
    const res = await fetch('/api/network');
    const data = await res.json();
    const p = document.getElementById('ip-display');
    if (p) p.textContent = 'Current IP: ' + data.ip;
  }

  async function loadDevices() {
    const res = await fetch('/api/devices');
    const data = await res.json();
    const tbody = document.querySelector('#devices tbody');
    tbody.innerHTML = '';
    data.forEach((ip, i) => {
      const tr = document.createElement('tr');
      const ipTd = document.createElement('td');
      ipTd.textContent = ip;
      const statusTd = document.createElement('td');
      statusTd.innerHTML = '<i class="fas fa-circle status-icon" data-ip="' + ip + '"></i>';
      const btn = document.createElement('button');
      btn.innerHTML = '<i class="fas fa-trash"></i> Delete';
      btn.onclick = async () => {
        await fetch('/api/devices/' + i, { method: 'DELETE' });
        loadDevices();
      };
      const actionTd = document.createElement('td');
      actionTd.appendChild(btn);
      tr.appendChild(ipTd);
      tr.appendChild(statusTd);
      tr.appendChild(actionTd);
      tbody.appendChild(tr);
    });
    updateStatuses();
  }

  async function updateStatuses() {
    const res = await fetch('/api/devices/status');
    const data = await res.json();
    document.querySelectorAll('.status-icon').forEach(icon => {
      const ip = icon.dataset.ip;
      if (data[ip]) {
        icon.style.color = 'green';
      } else {
        icon.style.color = 'red';
      }
    });
  }

  setInterval(updateStatuses, 5000);

  document.getElementById('add-form').onsubmit = async (e) => {
    e.preventDefault();
    const ip = document.getElementById('ip').value;
    await fetch('/api/devices', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ip })
    });
    e.target.reset();
    loadDevices();
  };

  loadDevices();
  loadNetwork();

  document.getElementById('scan-btn').onclick = () => {
    const net = document.getElementById('scan-net').value;
    const url = net ? '/api/devices/scan_stream?network=' + encodeURIComponent(net) : '/api/devices/scan_stream';
    const progress = document.getElementById('scan-progress');
    progress.value = 0;
    progress.style.display = 'inline';
    const es = new EventSource(url);
    es.onmessage = async (e) => {
      const data = JSON.parse(e.data);
      if ('progress' in data) progress.value = data.progress;
      if (data.device) {
        await fetch('/api/devices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ip: data.device })
        });
      }
      if (data.complete || data.error) {
        es.close();
        progress.style.display = 'none';
        if (data.error) alert(data.error);
        loadDevices();
      }
    };
  };

  async function loadAudio() {
    const res = await fetch('/api/audio');
    const data = await res.json();
    const list = document.getElementById('audio-list');
    list.innerHTML = '';
    const testSelect = document.getElementById('test-sound');
    if (testSelect) testSelect.innerHTML = '';
    data.forEach(file => {
      const div = document.createElement('div');
      div.className = 'audio-item';
      const span = document.createElement('span');
      span.textContent = file.name;
      div.appendChild(span);
      const edit = document.createElement('button');
      edit.innerHTML = '<i class="fas fa-edit"></i>';
      edit.onclick = async () => {
        const name = prompt('New name:', file.name);
        if (!name) return;
        await fetch('/api/audio/' + encodeURIComponent(file.file), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        loadAudio();
      };
      div.appendChild(edit);
      list.appendChild(div);
      if (testSelect) {
        const opt = document.createElement('option');
        opt.value = file.file;
        opt.textContent = file.name;
        testSelect.appendChild(opt);
      }
    });
  }

  document.getElementById('upload-form').onsubmit = async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById('audio-file');
    const nameInput = document.getElementById('audio-name');
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('name', nameInput.value);
    await fetch('/api/audio', { method: 'POST', body: formData });
    fileInput.value = '';
    nameInput.value = '';
    loadAudio();
  };

  loadAudio();

  document.getElementById('test-play').onclick = async () => {
    const sound = document.getElementById('test-sound').value;
    if (!sound) return;
    await fetch('/api/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sound_file: sound })
    });
  };
  </script>
  <footer>
    <div class="footer-left">
      <img src="/static/smallroundlogo.png" alt="PixelPacific logo" class="footer-logo" />
      <span>&copy; 2025 <a href="https://www.pixelpacific.com" target="_blank">PixelPacific LLC.</a></span>
    </div>
    <div id="hostname" class="footer-right"></div>
  </footer>
  <script>
  async function loadHostname() {
    try {
      const res = await fetch('/api/network');
      const data = await res.json();
      document.getElementById('hostname').textContent = data.hostname;
    } catch (e) {
      console.error(e);
    }
  }
  loadHostname();
  </script>
</body>
</html>
